# K8s secrets and resources #

---
Create a secret in your cluster using `kubctl`. 
```
PS C:\users\dappa\devops\devops\k8s> kubectl create secret generic devops-secret --from-literal=username=dapp7anyway --from-literal=password=devopsecret
secret/devops-secret created
PS C:\users\dappa\devops\devops\k8s> kubectl get secrets
NAME                                    TYPE                 DATA   AGE
devops-secret                           Opaque               2      23s
sh.helm.release.v1.devops-helm-app.v1   helm.sh/release.v1   1      15m
PS C:\users\dappa\devops\devops\k8s> kubectl describe secret devops-secret
Name:         devops-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
password:  11 bytes
username:  11 bytes
PS C:\users\dappa\devops\devops\k8s>
```
Decode secret

```
PS C:\users\dappa\devops\devops\k8s> kubectl get secret devops-secret -o jsonpath='{.data}'
{"password":"ZGV2b3BzZWNyZXQ=","username":"ZGFwcDdhbnl3YXk="}

PS C:\users\dappa\devops\devops\k8s> [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String("ZGV2b3BzZWNyZXQ="))
devopsecret

PS C:\users\dappa\devops\devops\k8s> [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String("ZGFwcDdhbnl3YXk="))
dapp7anyway
```

---

## Using Helm ##

Install plugins
```
PS C:\users\dappa\devops\devops\k8s> helm plugin install https://github.com/jkroepke/helm-secrets
Installed plugin: secrets
```

I installed `sops_3.7.3_amd64.deb` from this repository `https://github.com/mozilla/sops/releases`

```
dapp-anyway@DESKTOP-H7HVR0O:/mnt/c/users/dappa/devops/devops/k8s/devops-helm-app/templates$ sudo apt install ./sops_3.7.3_amd64.deb
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
Note, selecting 'sops' instead of './sops_3.7.3_amd64.deb'
The following NEW packages will be installed:
  sops
0 upgraded, 1 newly installed, 0 to remove and 9 not upgraded.
Need to get 0 B/12.7 MB of archives.
After this operation, 29.1 MB of additional disk space will be used.
Get:1 /mnt/c/users/dappa/devops/devops/k8s/devops-helm-app/templates/sops_3.7.3_amd64.deb sops amd64 3.7.3 [12.7 MB]
Selecting previously unselected package sops.
(Reading database ... 45426 files and directories currently installed.)
Preparing to unpack .../templates/sops_3.7.3_amd64.deb ...
Unpacking sops (3.7.3) ...
Setting up sops (3.7.3) ...
```

Generating `k8s/secrets.yaml`

```
dapp-anyway@DESKTOP-H7HVR0O:/mnt/c/users/dappa/devops/devops/k8s$ sops -p 7BB4204E5561D2874CDAE547341A41F8CE847C77 secrets.yaml
[PGP]    WARN[0000] Deprecation Warning: GPG key fetching from a keyserver within sops will be removed in a future version of sops. See https://github.com/mozilla/sops/issues/727 for more information.
```

Encrypting

```
dapp-anyway@DESKTOP-H7HVR0O:/mnt/c/users/dappa/devops/devops/k8s$ helm secrets decrypt secrets.yaml
password: devopsecret
```

Creation

```
dapp-anyway@DESKTOP-H7HVR0O:/mnt/c/users/dappa/devops/devops/k8s$ helm secrets install devops-helm-app ./devops-helm-app/ -f ./secrets.yaml
[helm-secrets] Decrypt: ./secrets.yaml
NAME: devops-helm-app
LAST DEPLOYED: Sun Feb 19 18:18:15 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get --namespace default svc -w mostime'
  export SERVICE_IP=$(kubectl get svc --namespace default mostime --template "{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}")
  echo http://$SERVICE_IP:8080

[helm-secrets] Removed: ./secrets.yaml.dec
```